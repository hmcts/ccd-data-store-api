Feature: Elastic Search Internal Endpoint

  Background: Load test data for the scenario
    Given an appropriate test context as detailed in the test data source
#
#    PRIVATE case type
#      - RESRICTED field
#    PUBLIC case type
#      - Field with no R access for main role
#      - case has no R access for junior role
#

#      @data
#    Scenario: Data setup for ES tests, case created by PRIVATE user
#
#      @data
#    Scenario: Data setup for ES tests, case created by PUBLIC user




    #idam role
  Scenario: Only recieve results for fields allowed by idam role configured in Search/workbasket results fields tab
    Given a user with [the caseworker-autotest1 idam role]
    And a case that has just been created as in [<some test data unique id>]
    When a request is prepared with appropriate values
    And it is submitted to call the [Search cases according to the provided ElasticSearch query] operation of [CCD Data Store]
    Then a positive response is received
    And the response [only contains results as specified for caseworker-autotest1 role]
    And the response has all other details as expected

    #idam role
  Scenario: Only recieve results for fields allowed by idam role configured in AuthorisationCaseField
    Given a user with [the caseworker-autotest1 idam role]
    And a case that has just been created as in [<some test data unique id>]
    When a request is prepared with appropriate values
    And it is submitted to call the [Search cases according to the provided ElasticSearch query] operation of [CCD Data Store]
    Then a positive response is received
    And the response [only contains results as specified for caseworker-autotest1 role]
    And the response has all other details as expected

    #case role
  Scenario: Only recieve results for fields allowed by case role configured in Search/workbasket results fields tab
    Given a user with [the DEFENDANT role]
    And a case that has just been created as in [<some test data unique id>]
    When a request is prepared with appropriate values
    And it is submitted to call the [Search cases according to the provided ElasticSearch query] operation of [CCD Data Store]
    Then a positive response is received
    And the response [does not contain results specified for CREATOR case role only]
    And the response has all other details as expected

    #case role
  Scenario: Only recieve results for fields allowed by case role configured in AuthorisationCaseField
    Given a user with [the DEFENDANT role]
    And a case that has just been created as in [<some test data unique id>]
    When a request is prepared with appropriate values
    And it is submitted to call the [Search cases according to the provided ElasticSearch query] operation of [CCD Data Store]
    Then a positive response is received
    And the response [does not contain results specified for CREATOR case role only]
    And the response has all other details as expected


#    CRUD / SC tests covered in external API - check these tests
       #CRUD
  Scenario: Only recieve results for fields with R CRUD access
    Given a user with [an active profile in CCD]
    And a case that has just been created as in [<some test data unique id>]
    When a request is prepared with appropriate values
    And it is submitted to call the [Search cases according to the provided ElasticSearch query] operation of [CCD Data Store]
    Then a positive response is received
    And the response [only contains fields with R CRUD access]
    And the response has all other details as expected

           #CRUD
  Scenario: Only recieve case that has R CRUD access
    Given a user with [no R crud access for a case type]
    And a case that has just been created as in [<some test data unique id>]
    When a request is prepared with appropriate values
    And it is submitted to call the [Search cases according to the provided ElasticSearch query] operation of [CCD Data Store]
    Then a positive response is received
    And the response [?? does not contain any results for the specified case type]

    #SC
  @S-600   @elasticsearch  #SC
  Scenario: should return the case for a role with same security classification as case type classification and read access on case type
    Given a user with [a role with security classification of PRIVATE]
    And a case that has just been created as in [F-103-Test_AAT_PRIVATE]
    When a request is prepared with appropriate values
    And it is submitted to call the [Search cases according to the provided ElasticSearch query] operation of [CCD Data Store]
    Then a positive response is received
    And the response [contains the previously created case]
    And the response has all other details as expected

    #SC
  Scenario: should NOT return the case for a role with read access on case type and lower security classification than then case type
    Given a user with [a role with security classification of PUBLIC]
    And a case that has just been created as in [<some test data unique id>]
    When a request is prepared with appropriate values
    And it is submitted to call the [Search cases according to the provided ElasticSearch query] operation of [CCD Data Store]
    Then a positive response is received
    And the response [?? does not contain any results for the specified case type]

  @S-600   @elasticsearch  #SC
  Scenario: should return the case for a role with same security classification as case type classification and read access on case type
    Given a case that has just been created as in [Private_Case_Creation_Data]
    And logstash has finished indexing case data
    And a user with [a role with security classification of PRIVATE]
    When the request [is configured to search for the previously created case via exact match]
    And a request is prepared with appropriate values
    And it is submitted to call the [internal search query] operation of [CCD Data Store Elastic Search API]
    Then a positive response is received
    And the response [contains the previously created case data]
    And the response has all other details as expected



     #possitive request scenario of each type
  Scenario: Usecase request using SearchResultsFields useCase returns correct fields
    Given a case that has just been created as in [Private_Case_Creation_Data]
    And logstash has finished indexing case data
    And a user with [a role with security classification of PRIVATE]
    When the request [is configured to search for the previously created case via exact match]
    And the request [is using the query paraeter usecase=workbasket]
    And a request is prepared with appropriate values
    And it is submitted to call the [internal search query] operation of [CCD Data Store Elastic Search API]
    Then a positive response is received
    And the response [contains the fields as specified in the SearchResultsFields only]
    And the response has all other details as expected

  Scenario: Usecase request using WorkbasketResultsFields useCase returns correct fields
    Given a case that has just been created as in [Private_Case_Creation_Data]
    And logstash has finished indexing case data
    And a user with [a role with security classification of PRIVATE]
    When the request [is configured to search for the previously created case via exact match]
    And the request [is using the query paraeter usecase=search]
    And a request is prepared with appropriate values
    And it is submitted to call the [internal search query] operation of [CCD Data Store Elastic Search API]
    Then a positive response is received
    And the response [contains the fields as specified in the WorkbasketResultsFields only]
    And the response has all other details as expected

  Scenario: Usecase request using SearchCasesResultFields useCase returns correct fields
    Given a case that has just been created as in [Private_Case_Creation_Data]
    And logstash has finished indexing case data
    And a user with [a role with security classification of PRIVATE]
    When the request [is configured to search for the previously created case via exact match]
    And the request [is using the query paraeter usecase=searchCase??]
    And a request is prepared with appropriate values
    And it is submitted to call the [internal search query] operation of [CCD Data Store Elastic Search API]
    Then a positive response is received
    And the response [contains the fields as specified in the SearchCasesResultFields only]
    And the response has all other details as expected

  Scenario: Standard request return all fields in a case user has access to
    Given a case that has just been created as in [Private_Case_Creation_Data]
    And logstash has finished indexing case data
    And a user with [a role with security classification of PRIVATE]
    When the request [is configured to search for the previously created case via exact match]
    And the request [is using not using any use case query parameter]
    And a request is prepared with appropriate values
    And it is submitted to call the [internal search query] operation of [CCD Data Store Elastic Search API]
    Then a positive response is received
    And the response [contains all the fields for the case]
    And the response has all other details as expected


  Scenario: Request can return meta data fields
  Scenario: Standard request will return only specified fields when configured in the payload
    Given a case that has just been created as in [Private_Case_Creation_Data]
    And logstash has finished indexing case data
    And a user with [a role with security classification of PRIVATE]
    When the request [is configured to search for the previously created case via exact match]
    And the request [is using not using any use case query parameter]
    And the request [is configured to return a selection of regular and meta data fields]
    And a request is prepared with appropriate values
    And it is submitted to call the [internal search query] operation of [CCD Data Store Elastic Search API]
    Then a positive response is received
    And the response [contains only the specified fields]
    And the response has all other details as expected




     #cross case type request
  Scenario: Standard Request search can be performed across different case types
    Given a case that has just been created as in [Private_Case_Creation_Data]
    Given a case that has just been created as in [Private2_Case_Creation_Data]
    And logstash has finished indexing case data
    And a user with [a role with security classification of PRIVATE]
    When the request [is configured to search for both previously created cases]
    And the request [is using not using any use case query parameter]
    And a request is prepared with appropriate values
    And it is submitted to call the [internal search query] operation of [CCD Data Store Elastic Search API]
    Then a positive response is received
    And the response [contains cases from both case types]
    And the response has all other details as expected

  Scenario: Pre-Configured Request search can be performed across different case types
    Given a case that has just been created as in [Private_Case_Creation_Data]
    Given a case that has just been created as in [Private2_Case_Creation_Data]
    And logstash has finished indexing case data
    And a user with [a role with security classification of PRIVATE]
    When the request [is configured to search for both previously created cases]
    And the request [is using the query paraeter usecase=searchCase??]
    And a request is prepared with appropriate values
    And it is submitted to call the [internal search query] operation of [CCD Data Store Elastic Search API]
    Then a positive response is received
    And the response [contains cases from both case types]
    And the response has all other details as expected


#    #Pagination
#  Scenario: Request can be sent with paginated search criteria
#  Scenario: cross case type request can be sent with paginated criteria
#  Scenario: Any Search request will return total amount of cases found
#
#    #Ordering
#  Scenario: Usecase request will return cases ordered as per relevant definition configuration
#  Scenario: Usecase request override sorting in request
#  Scenario: Standard request can be ordered by metadata field
##  Scenario: Standard cross-casetype search can be ordered by a metadata field - handles in another ticket
#  Scenario:  Pre-Configured cross-casetype search can be ordered ?? CAN we do this for Usecase with ordering? - TBD
#
#
#  Scenario: CaseType Headers are returned even if no cases are found for a search request of any type
#  Scenario: Usecase request returns labels and hint text data from the corresponding definition configuration tab
#  Scenario: Standard request returns correct label and hint text data


