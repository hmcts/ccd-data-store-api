import groovy.xml.XmlUtil

def suppressCves(reportPath, suppressionsPath) {
    def report = new XmlSlurper().parse(new FileReader(reportPath))
    def vulns = report.'**'.findAll { node -> node.name() == 'vulnerability' }.collect { it.name.text() } as Set<String>

    if (vulns) {
        def file = file(suppressionsPath)
        def suppressions = new XmlSlurper(false, false).parse(file)

        vulns.each {
            def cveName = it
            println(cveName)
            suppressions.appendNode {
                suppress {
                    notes('Ticket TBC')
                    cve(cveName)
                }
            }
        }

        println(XmlUtil.serialize(suppressions))

        file.write(XmlUtil.serialize(suppressions))
    }
}

task suppressCves() {
    doLast {
        suppressCves('./build/reports/dependency-check-report.xml', './dependency-check-suppressions.xml')
    }
}
