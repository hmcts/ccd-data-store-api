# API Security

CCD's APIs are secured with IDAM's user and service authorisation.

## User authentication

Endpoints are secured with IDAM authentication. As such, a valid JWT token representing an existing IDAM user is expected.
The user JWT token MUST be provided using the `Authorization` header, as follows:
```
Authorization: Bearer <user jwt token>
```

## User authorization

Access control is achieved with IDAM's roles.

### Citizen resources

Citizen resources have a URL starting with `/citizens/{user_id}/...`.
A user calling such resource MUST own the role `citizen` in IDAM.

The `{user_id}` path parameter MUST be the ID of the IDAM user whose JWT token is provided.

### Caseworker resources

Caseworker resources have a URL starting with `/caseworkers/{user_id}/jurisdictions/{jurisdiction_id}/...`.

A user calling such resource MUST own the role `caseworker-{jurisdiction_id}` in IDAM.
For instance, given the jurisdiction with ID `DIVORCE`, the required role would be `caseworker-divorce`.

**Note:** The jurisdiction ID in the role is always lowercase.

The `{user_id}` path parameter MUST be the ID of the IDAM user whose JWT token is provided.

## Service authentication

### Definition of a service

A service MUST be registered with IDAM.

A service is represented by a `microservice_name` and a `secret`.
The `secret` is generated by IDAM as part of the service registration and is different for every environment (Dev, Test, Demo, Production,...).

### Service token generation

Once registered, a service can generate service JWT token identifying itself.
This is done by exchanging the `microservice_name` and a One-Time Password (TOTP) generated using the service's `secret`.

- *Spring Boot library for generating token in Java:*
- *Example of token generation in Node:*

### Calling CCD APIs

Endpoints are secured with IDAM service authentication, in addition to user authentication described above.

Service authentication is achieved by providing a service JWT token as part of the API call.
The service JWT token MUST be provided using the `ServiceAuthorization` as follows:
```
ServiceAuthorization: <service jwt token>
```

## Service authorisation

Once a service has been authenticated, it has to be authorised.

CCD's APIs can only be called by a list of authorised `microservice_name`. This authorisation is achieved by comparing the service JWT token with the list of authorised services provided as part of the API's configuration.

To get your micro-service authorised, please raise a ticket with CCD.

## Callback security hardening

Event callback URLs are validated both at definition ingestion/read-time and again before outbound requests are sent (defense in depth). This is required to reduce SSRF and token leakage risk when callback URLs originate from case definition data.

### Objective

Prevent untrusted callback destinations from being invoked and prevent sensitive credential/context headers from being leaked during callback execution.

- Callback hosts must be allowlisted (`CCD_CALLBACK_ALLOWED_HOSTS`).
- Callback URLs must use `https` unless the host is explicitly approved for `http` (`CCD_CALLBACK_ALLOWED_HTTP_HOSTS`).
- Callback hosts that resolve to local/private ranges are blocked unless explicitly approved (`CCD_CALLBACK_ALLOW_PRIVATE_HOSTS`).
- Callback URLs with embedded credentials are rejected (`https://user:pass@host/...`).
- Sensitive inbound/user headers are not forwarded to callbacks (`Authorization`, `ServiceAuthorization`, `user-id`, `user-roles`).

### Service rollout checklist

After enabling callback hardening, service teams should:

1. Ensure callback URLs do not contain embedded credentials (`user:pass@host`).
2. Configure trusted callback destinations with:
   - `CCD_CALLBACK_ALLOWED_HOSTS`
   - `CCD_CALLBACK_ALLOWED_HTTP_HOSTS` (only for explicitly approved `http` hosts)
   - `CCD_CALLBACK_ALLOW_PRIVATE_HOSTS` (only for explicitly approved private/local hosts)
3. Validate callback URLs during definition onboarding/import so invalid URLs are rejected before runtime.
4. Re-run callback integration tests and verify expected callback hosts are accepted.
5. Update alerting/log triage rules to use redacted callback URL output (query and credentials are not logged).
